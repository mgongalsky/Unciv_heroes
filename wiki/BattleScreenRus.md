# Обзор класса BattleScreen

Класс `BattleScreen` отвечает за визуализацию сражения в игре. Логика сражения управляется классом `BattleManager`, а `BattleScreen` занимается отрисовкой, взаимодействием с пользователем и анимацией. Этот класс связывает пользовательский ввод (например, клики) с логическими действиями и отображает результаты на экране.

## Основные задачи
1. **Отрисовка поля битвы**: Создание и управление сеткой шестиугольных тайлов, представляющих поле боя.
2. **Отображение войск**: Показывает войска обеих армий, обновляет их позиции, действия и параметры во время боя.
3. **Управление указателем и курсором**: Подсвечивает активный отряд и меняет курсор мыши в зависимости от взаимодействия (например, атака, движение).
4. **Обработка действий**: Преобразует пользовательские действия в логические команды (например, перемещение, атака) и передает их в `BattleManager`.
5. **Анимации боя**: Обрабатывает визуальные эффекты, такие как птица морали, радуга удачи и перемещение войск.

## Основные методы

### `draw_pointer()`
Отображает визуальный указатель на тайле текущего активного отряда и добавляет его в соответствующую группу. Управляет внешним видом и размещением указателя относительно позиции отряда.

### `addTiles()`
Создает поле битвы, добавляя тайлы и инициализируя позиции войск. Настраивает обработчики событий для каждого тайла для обработки взаимодействий пользователя, таких как клики и движения мыши.

### `handleTileClick(tileGroup: TileGroup, x: Float, y: Float)`
Определяет тип действия (перемещение, атака, выстрел) в зависимости от выбранного тайла. Проверяет валидность действия и отправляет запрос в `BattleManager` для его выполнения. Корректно обрабатывает недопустимые или недостижимые действия.

### `moveTroopView(troopView: TroopBattleView, targetTileGroup: TileGroup)`
Обновляет визуальное расположение отряда на поле битвы, перемещая его представление в целевой тайл.

### `refreshTroopViews()`
Синхронизирует отображение отрядов с текущим состоянием их армий в `BattleManager`. Обновляет параметры, обрабатывает смерть отрядов и удаляет недействительные представления.

### `updateTilesShadowing()`
Подсвечивает тайлы, которые может достичь текущий активный отряд, используя прозрачность для указания доступности.

### `showMoraleBird(troopView: TroopBattleView)`
Отображает анимацию птицы морали над отрядом, когда он получает бонус морали. Анимация включает последовательное появление и исчезновение.

### `showLuckRainbow(troopView: TroopBattleView)`
Отображает анимацию радуги удачи рядом с отрядом, когда он получает эффект удачи. Анимация также плавно появляется и исчезает.

### `chooseCrosshair(tileGroup: TileGroup, x: Float, y: Float, width: Float)`
Определяет соответствующий курсор (например, атака, движение, выстрел) в зависимости от тайла и позиции мыши, обеспечивая визуальную обратную связь для действий пользователя.

### `pixelToDirection(x: Float, y: Float, width: Float): Direction`
Рассчитывает направление атаки на основе позиции клика мыши внутри шестиугольного тайла. Используется для определения позиции, куда должен двигаться отряд для атаки врага.

## Позиция в архитектуре
`BattleScreen` находится на пересечении пользовательского интерфейса игры и логики сражения. Этот класс действует как мост между действиями игрока (через UI) и симуляцией боя (через `BattleManager`). Он гарантирует, что действия игрока визуально отображаются, а результаты сражения демонстрируются наглядно и информативно.

## Заметки по использованию
- **Не для сражений ИИ**: Класс предназначен для взаимодействия игрока и не должен использоваться для сражений, проводимых только ИИ.
- **Событийно-ориентированный**: Класс активно использует слушатели событий и обратные вызовы для обработки взаимодействий пользователя и динамического обновления UI.
- **Корутины**: Некоторые функции (например, `runBattleLoop`) используют корутины для выполнения асинхронных операций, таких как ожидание ввода пользователя.
